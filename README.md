# DB Migrator

DB Migrator - это инструмент для миграции PostgreSQL баз данных из Kubernetes кластера на Bare-Metal сервер с использованием логической репликации. Приложение предоставляет как TUI (Text User Interface) для интерактивной работы, так и режим планировщика для автоматизированных миграций.

## Архитектура проекта

### Основные компоненты

- **main.go** - точка входа в приложение, обработка аргументов командной строки
- **migrator.go** - основная логика миграции, реализация шагов миграции
- **tui.go** - текстовый пользовательский интерфейс с использованием библиотеки Bubble Tea
- **planner.go** - планировщик миграций для управления сложными сценариями
- **config.go** - структуры и функции для загрузки конфигурации
- **logger.go** - настройка логирования

### Структура проекта

```
├── command.go              # Вспомогательные функции для выполнения команд
├── config.go               # Конфигурационные структуры и загрузка
├── config.yaml             # Основной файл конфигурации
├── config_tester.go        # Тестирование конфигурации
├── config-test.yaml        # Тестовый файл конфигурации
├── Dockerfile              # Docker-файл для контейнеризации приложения
├── Docs/                   # Документация
├── go.mod, go.sum          # Зависимости Go
├── logger.go               # Настройка логирования
├── main.go                 # Точка входа
├── migrator.go             # Основная логика миграции
├── planner.go              # Планировщик миграций
├── planner_usage.go        # Пример использования планировщика
├── tui.go                  # Текстовый интерфейс
├── values-statefulsets.yaml # Файл конфигурации StatefulSet'ов
└── migrate-to-k8s/         # Дополнительная документация по миграции
```

## Функциональность

### Основные возможности

1. **Миграция PostgreSQL баз данных из Kubernetes на Bare-Metal**
   - Использование логической репликации PostgreSQL
   - Поддержка миграции нескольких баз данных
   - Интерактивный и автоматический режимы работы

2. **Текстовый пользовательский интерфейс (TUI)**
   - Выбор баз данных для миграции
   - Отображение прогресса миграции
   - Просмотр логов в реальном времени
   - Подтверждение финального переключения

3. **Планировщик миграций**
   - Создание планов миграции
   - Управление зависимостями между базами данных
   - Поддержка параллельных и последовательных миграций
   - Возможность отката при ошибках

4. **Безопасность и откат**
   - Система отката для восстановления состояния при ошибках
   - Поддержка "сухого запуска" для тестирования
   - Подробное логирование всех операций

### Шаги миграции

1. **Подготовка миграции** - получение IP-адреса узла Kubernetes
2. **Настройка публикатора** - включение логической репликации в Kubernetes PostgreSQL
3. **Миграция схемы** - дамп и восстановление структуры БД на Bare-Metal
4. **Запуск и проверка репликации** - настройка подписки на Bare-Metal и проверка синхронизации
5. **Выдача прав приложения** - предоставление необходимых прав на Bare-Metal
6. **Финальное переключение** - остановка Kubernetes StatefulSet и завершение репликации

## Требования

- Go 1.25.4 или выше
- kubectl
- PostgreSQL клиент (pg_dump)
- SSH доступ к Bare-Metal серверу
- Учетная запись PostgreSQL на Bare-Metal сервере

## Установка и настройка

### Локальная установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd db-migrator
   ```

2. Установите зависимости:
   ```bash
   go mod download
   ```

3. Соберите приложение:
   ```bash
   go build -o db-migrator .
   ```

### Конфигурация

Основная конфигурация находится в файле `config.yaml`:

```yaml
valuesFile: "values-statefulsets.yaml"  # Путь к файлу с описанием StatefulSet'ов
k8sNamespace: "dev"                     # Пространство имен Kubernetes
bmHost: "172.17.1.22"                   # IP-адрес Bare-Metal сервера
bmSSHUser: "user"                       # Пользователь SSH на Bare-Metal
bmPGUser: "postgres"                    # Пользователь PostgreSQL на Bare-Metal
nodePortBase: 30000                     # Базовый порт для NodePort'ов
dbNameSuffix: ""                        # Суффикс для имен БД на Bare-Metal (опционально)
```

Файл `values-statefulsets.yaml` содержит описание StatefulSet'ов Kubernetes и их конфигурации:

```yaml
statefulset_templates:  # Шаблоны для StatefulSet'ов
  postgres: &postgres-template
    service:
      port: 5432
    image:
      repository: postgres
      tag: 16.3-alpine
    # ... другие настройки шаблона

statefulsets:  # Конкретные StatefulSet'ы для миграции
  postgres-account:
    <<: *postgres-template
    nodePort: 32
    configMap:
      POSTGRES_DB: account
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    # ... другие настройки
```

## Использование

### Интерактивный режим (TUI)

```bash
./db-migrator
```

### Режим планировщика

```bash
./db-migrator --planner
```

### Сухой запуск (тестирование без выполнения команд)

```bash
./db-migrator --dry-run
```

### Подробный вывод логов

```bash
./db-migrator --verbose
```

### Использование кастомного файла конфигурации

```bash
./db-migrator --config /path/to/config.yaml
```

## Docker

Приложение можно собрать в Docker-контейнер:

```bash
docker build -t db-migrator .
```

Запуск контейнера:

```bash
docker run -it --rm \
  -v /path/to/config.yaml:/app/config.yaml \
  -v /path/to/values-statefulsets.yaml:/app/values-statefulsets.yaml \
  -v ~/.kube/config:/app/.kube/config:ro \
  db-migrator
```

## Параметры командной строки

- `--config` - путь к файлу конфигурации (по умолчанию: `config.yaml`)
- `--dry-run` - запустить в режиме сухого запуска без выполнения реальных команд
- `--planner` - использовать планировщик миграций
- `--verbose` - включить подробный вывод логов
- `--quiet` - уменьшить вывод логов (только ошибки)

## Безопасность

- Приложение использует систему отката для восстановления состояния при ошибках
- Поддержка "сухого запуска" для безопасного тестирования
- Все операции логируются в файл `migration.log`
- Поддержка настройки прав доступа к базам данных

## Режимы работы

### Интерактивный режим (TUI)

- Выбор баз данных для миграции
- Пошаговый процесс с подтверждением
- Отображение прогресса и статуса
- Возможность просмотра логов в реальном времени

### Режим планировщика

- Автоматическая генерация плана миграции
- Поддержка зависимостей между базами данных
- Возможность параллельного выполнения
- Автоматический откат при ошибках

## Структура конфигурации

Файл `values-statefulsets.yaml` содержит:

- Шаблоны для StatefulSet'ов (postgres, redis, kafka)
- Конкретные описания StatefulSet'ов с базами данных
- Настройки подключения к базам данных
- Параметры для миграции

## Поддержка нескольких БД

Приложение поддерживает миграцию нескольких баз данных одновременно:

- Миграция может быть выполнена для одной или нескольких БД
- Поддержка параллельной миграции с ограничением по количеству одновременных операций
- Индивидуальный контроль прогресса для каждой БД
- Общий прогресс миграции

## Логирование

- Все операции логируются в файл `migration.log`
- Поддержка различных уровней логирования (debug, info, error)
- Возможность просмотра логов в TUI
- Подробное логирование ошибок с контекстом

## Роли и публикации

При миграции автоматически создаются:

- Роль репликатора с необходимыми правами
- Публикация для логической репликации
- Подписка на Bare-Metal сервере
- Необходимые права для приложения на Bare-Metal

## Поддержка логической репликации

- Автоматическое изменение параметра `wal_level` на `logical`
- Создание публикаций и подписок
- Проверка статуса репликации
- Мониторинг синхронизации данных

## Финальное переключение

- Интерактивное подтверждение финального шага
- Удаление подписки на Bare-Metal
- Остановка Kubernetes StatefulSet
- Проверка завершения миграции

## Авторы

Проект разработан как инструмент для миграции PostgreSQL баз данных из Kubernetes на Bare-Metal сервера.

## Лицензия

Проект распространяется под лицензией, определенной владельцами репозитория.